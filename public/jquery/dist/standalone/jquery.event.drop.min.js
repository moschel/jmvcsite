(function(e){var m=e.event,k=["dropover","dropon","dropout","dropinit","dropmove","dropend"];e.Drop=function(a,b){jQuery.extend(this,a);this.element=e(b)};e.each(k,function(){m.special[this]={add:function(){var a=e(this),b=a.data("dropEventCount")||0;a.data("dropEventCount",b+1);b==0&&e.Drop.addElement(this)},remove:function(){var a=e(this),b=a.data("dropEventCount")||0;a.data("dropEventCount",b-1);b<=1&&e.Drop.removeElement(this)}}});e.extend(e.Drop,{lowerName:"drop",_rootElements:[],_elements:e(),
last_active:[],endName:"dropon",addElement:function(a){for(var b=0;b<this._rootElements.length;b++)if(a==this._rootElements[b])return;this._rootElements.push(a)},removeElement:function(a){for(var b=0;b<this._rootElements.length;b++)if(a==this._rootElements[b]){this._rootElements.splice(b,1);return}},sortByDeepestChild:function(a,b){a=a.element.compare(b.element);if(a&16||a&4)return 1;if(a&8||a&2)return-1;return 0},isAffected:function(a,b,c){return c.element!=b.element&&c.element.within(a[0],a[1],
c._cache).length==1},deactivate:function(a,b,c){b.out(c,a);a.callHandlers(this.lowerName+"out",a.element[0],c,b)},activate:function(a,b,c){b.over(c,a);a.callHandlers(this.lowerName+"over",a.element[0],c,b)},move:function(a,b,c){a.callHandlers(this.lowerName+"move",a.element[0],c,b)},compile:function(a,b){if(this.dragging||b){if(!this.dragging){this.dragging=b;this.last_active=[]}for(var c,d,g,f=[],i=this.dragging,h=0;h<this._rootElements.length;h++){b=this._rootElements[h];c=e.event.findBySelector(b,
k);for(d in c){g=d?jQuery(d,b):[b];for(var j=0;j<g.length;j++)this.addCallbacks(g[j],c[d],i)&&f.push(g[j])}}this.add(f,a,i)}},addCallbacks:function(a,b,c){var d=e.data(a,"_dropData");if(d){if(!c){for(var g in b)d[g]=d[g]?d[g].concat(b[g]):b[g];return false}}else{e.data(a,"_dropData",new e.Drop(b,a));return true}},add:function(a,b,c){for(var d=0,g;d<a.length;){g=e.data(a[d],"_dropData");g.callHandlers(this.lowerName+"init",a[d],b,c);if(g._canceled)a.splice(d,1);else d++}this._elements.push.apply(this._elements,
a)},show:function(a,b,c){if(this._elements.length){var d=[],g=true,f=0,i,h,j,l=this.last_active;for(i=this;f<this._elements.length;)if(h=e.data(this._elements[f],"_dropData")){f++;i.isAffected(a,b,h)&&d.push(h)}else this._elements.splice(f,1);d.sort(this.sortByDeepestChild);c.stopRespondPropagate=function(){g=false};h=d.slice();this.last_active=d;for(a=0;a<l.length;a++){i=l[a];for(f=0;j=h[f];)if(i==j){h.splice(f,1);break}else f++;j||this.deactivate(i,b,c);if(!g)return}for(f=0;f<h.length;f++){this.activate(h[f],
b,c);if(!g)return}for(f=0;f<d.length;f++){this.move(d[f],b,c);if(!g)return}}},end:function(a,b){var c;c=this.lowerName+"end";for(var d=0;d<this._elements.length;d++)e.data(this._elements[d],"_dropData").callHandlers(c,null,a,b);for(d=0;d<this.last_active.length;d++){c=this.last_active[d];this.isAffected(a.vector(),b,c)&&c[this.endName]&&c.callHandlers(this.endName,null,a,b)}this.clear()},clear:function(){this._elements.each(function(){e.removeData(this,"_dropData")});this._elements=e();delete this.dragging}});
e.Drag.responder=e.Drop;e.extend(e.Drop.prototype,{callHandlers:function(a,b,c,d){for(var g=this[a]?this[a].length:0,f=0;f<g;f++)this[a][f].call(b||this.element[0],c,this,d)},cache:function(a){this._cache=a!=null?a:true},cancel:function(){this._canceled=true}})})(jQuery);
