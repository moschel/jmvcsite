(function(f){var m=f.event,k=["dropover","dropon","dropout","dropinit","dropmove","dropend"];f.Drop=function(a,b){jQuery.extend(this,a);this.element=b};f.each(k,function(){m.special[this]={add:function(){var a=f(this),b=a.data("dropEventCount")||0;a.data("dropEventCount",b+1);b==0&&f.Drop.addElement(this)},remove:function(){var a=f(this),b=a.data("dropEventCount")||0;a.data("dropEventCount",b-1);b<=1&&f.Drop.removeElement(this)}}});f.extend(f.Drop,{lowerName:"drop",_elements:[],_responders:[],last_active:[],
endName:"dropon",addElement:function(a){for(var b=0;b<this._elements.length;b++)if(a==this._elements[b])return;this._elements.push(a)},removeElement:function(a){for(var b=0;b<this._elements.length;b++)if(a==this._elements[b]){this._elements.splice(b,1);return}},sortByDeepestChild:function(a,b){a=a.element.compare(b.element);if(a&16||a&4)return 1;if(a&8||a&2)return-1;return 0},isAffected:function(a,b,c){return c.element!=b.element&&c.element.within(a[0],a[1],c).length==1},deactivate:function(a,b,c){b.out(c,
a);a.callHandlers(this.lowerName+"out",a.element[0],c,b)},activate:function(a,b,c){b.over(c,a);a.callHandlers(this.lowerName+"over",a.element[0],c,b)},move:function(a,b,c){a.callHandlers(this.lowerName+"move",a.element[0],c,b)},compile:function(a,b){var c,d,g,e;this.last_active=[];for(var i=0;i<this._elements.length;i++){c=this._elements[i];d=f.event.findBySelector(c,k);for(g in d){e=g?jQuery(g,c):[c];for(var h=0;h<e.length;h++){jQuery.removeData(e[h],"offset");this.add(e[h],new this(d[g]),a,b)}}}},
add:function(a,b,c,d){a=jQuery(a);b=new f.Drop(b,a);b.callHandlers(this.lowerName+"init",a[0],c,d);b._canceled||this._responders.push(b)},show:function(a,b,c){if(this._responders.length){var d=[],g=true,e,i,h,j,l=this.last_active;for(e=0;e<this._responders.length;e++)this.isAffected(a,b,this._responders[e])&&d.push(this._responders[e]);d.sort(this.sortByDeepestChild);c.stopRespondPropagate=function(){g=false};h=d.slice();this.last_active=d;for(e=0;e<l.length;e++){i=l[e];for(a=0;j=h[a];)if(i==j){h.splice(a,
1);break}else a++;j||this.deactivate(i,b,c);if(!g)return}for(a=0;a<h.length;a++){this.activate(h[a],b,c);if(!g)return}for(a=0;a<d.length;a++){this.move(d[a],b,c);if(!g)return}}},end:function(a,b){var c;for(c=0;c<this._responders.length;c++)this._responders[c].callHandlers(this.lowerName+"end",null,a,b);for(var d=0;d<this.last_active.length;d++){c=this.last_active[d];this.isAffected(a.vector(),b,c)&&c[this.endName]&&c.callHandlers(this.endName,null,a,b)}this.clear()},clear:function(){this._responders=
[]}});f.Drag.responder=f.Drop;f.extend(f.Drop.prototype,{callHandlers:function(a,b,c,d){for(var g=this[a]?this[a].length:0,e=0;e<g;e++)this[a][e].call(b||this.element[0],c,this,d)},cache:function(a){this._cache=a!=null?a:true},cancel:function(){this._canceled=true}})})(jQuery);
