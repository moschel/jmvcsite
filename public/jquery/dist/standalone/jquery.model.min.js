(function(){var j=$.String.underscore,n=$.String.classize,i=function(a,b,c,e,f,d){b=$.extend({},b);a=$.String.sub(a,b,true);$.ajax({url:a,data:b,success:c,error:e,type:d||"post",dataType:"json",fixture:f})},l=function(){return"//"+$.String.underscore(this.fullName).replace(/\.models\..*/,"").replace(/\./g,"/")+"/fixtures/"+$.String.underscore(this.shortName)},o=function(a,b){a=a||{};if(a[this.id]){a["new"+$.String.capitalize(this.id)]=a[this.id];delete a[this.id]}a[this.id]=b;return a},m={create:function(a){return function(b,
c,e){i(a,b,c,e,"-restCreate")}},update:function(a){return function(b,c,e,f){i(a,o.call(this,c,b),e,f,"-restUpdate")}},destroy:function(a){return function(b,c,e){var f={};f[this.id]=b;i(a,f,c,e,"-restDestroy")}},findAll:function(a){return function(b,c,e){i(a,b,this.callback(["wrapMany",c]),e,l.call(this)+"s.json","get")}},findOne:function(a){return function(b,c,e){i(a,b,this.callback(["wrap",c]),e,l.call(this)+".json","get")}}};jQuery.Class.extend("jQuery.Model",{setup:function(a,b,c){if(!this.attributes||
a.attributes===this.attributes)this.attributes={};if(!this.associations||a.associations===this.associations)this.associations={};if(!this.validations||a.validations===this.validations)this.validations={};if(a.convert!=this.convert)this.convert=$.extend(a.convert,this.convert);this._fullName=j(this.fullName.replace(/\./g,"_"));if(this.fullName.substr(0,7)!="jQuery."){jQuery.Model.models[this._fullName]=this;if(this.listType)this.list=new this.listType([]);c||steal.dev.warn("model.js "+this.fullName+
" has no static properties.  You probably need  ,{} ");for(var e in m)if(typeof this[e]==="string")this[e]=m[e](this[e])}},attributes:{},defaults:{},wrap:function(a){if(!a)return null;return new this(a[this.singularName]||a.data||a.attributes||a)},wrapMany:function(a){if(!a)return null;var b=new (this.List||$.Model.List||Array),c=$.isArray(a),e=c?a:a.data,f=e.length,d=0;f||steal.dev.warn("model.js wrapMany has no data.  If you're trying to wrap 1 item, use wrap. ");for(b._use_call=true;d<f;d++)b.push(this.wrap(e[d]));
if(!c)for(var g in a)if(g!=="data")b[g]=a[g];return b},id:"id",addAttr:function(a,b){if(!this.associations[a]){this.attributes[a]||(this.attributes[a]=b);return b}},models:{},publish:function(a,b){steal.dev.log("Model.js - publishing "+j(this.shortName)+"."+a);window.OpenAjax&&OpenAjax.hub.publish(j(this.shortName)+"."+a,b)},guessType:function(a){if(typeof a!="string"){if(a===null)return typeof a;if(a.constructor==Date)return"date";if($.isArray(a))return"array";return typeof a}if(a==="")return"string";
if(a=="true"||a=="false")return"boolean";if(!isNaN(a)&&isFinite(+a))return"number";return typeof a},convert:{date:function(a){return typeof a==="string"?isNaN(Date.parse(a))?null:Date.parse(a):a},number:function(a){return parseFloat(a)},"boolean":function(a){return Boolean(a)}}},{setup:function(a){this._initializing=true;this.Class.defaults&&this.attrs(this.Class.defaults);this.attrs(a);delete this._initializing},update:function(a,b,c){this.attrs(a);return this.save(b,c)},errors:function(a){if(a)a=
$.isArray(a)?a:$.makeArray(arguments);var b={},c=this,e=function(d,g){$.each(g,function(h,k){if(h=k.call(c)){b.hasOwnProperty(d)||(b[d]=[]);b[d].push(h)}})};$.each(a||this.Class.validations||{},function(d,g){if(typeof d=="number"){d=g;g=c.Class.validations[d]}e(d,g||[])});for(var f in b)if(b.hasOwnProperty(f))return b;return null},attr:function(a,b,c,e){var f=n(a),d="get"+f;if(b!==undefined){this._setProperty(a,b,c,e,f);return this}return this[d]?this[d]():this[a]},bind:function(){var a=$(this);a.bind.apply(a,
arguments);return this},unbind:function(){var a=$(this);a.unbind.apply(a,arguments);return this},_setProperty:function(a,b,c,e,f){f="set"+f;var d=this[a],g=this,h=function(k){e&&e.call(g,k);$(g).triggerHandler("error."+a,k)};this[f]&&(b=this[f](b,this.callback("_updateProperty",a,b,d,c,h),h))===undefined||this._updateProperty(a,b,d,c,h)},_updateProperty:function(a,b,c,e,f){var d=this.Class,g=d.attributes[a]||d.addAttr(a,d.guessType(b)),h=d.convert[g];g=null;b=this[a]=b===null?null:h?h.call(d,b):b;
this._initializing||(g=this.errors(a));if(g)f(g);else{c!==b&&!this._initializing&&$(this).triggerHandler(a,b);e&&e(this)}if(a==d.id&&b!==null&&d.list)if(c){if(c!=b){d.list.remove(c);d.list.push(this)}}else d.list.push(this)},attrs:function(a){var b;if(a){var c=this.Class.id;for(b in a)b!=c&&this.attr(b,a[b]);c in a&&this.attr(c,a[c])}else{a={};for(b in this.Class.attributes)if(this.Class.attributes.hasOwnProperty(b))a[b]=this.attr(b)}return a},isNew:function(){return this[this.Class.id]===undefined},
save:function(a,b){if(this.errors())return false;this.isNew()?this.Class.create(this.attrs(),this.callback(["created",a]),b):this.Class.update(this[this.Class.id],this.attrs(),this.callback(["updated",a]),b);return true},destroy:function(a,b){this.Class.destroy(this[this.Class.id],this.callback(["destroyed",a]),b)},identity:function(){var a=this[this.Class.id];return this.Class._fullName+"_"+(this.Class.escapeIdentity?encodeURIComponent(a):a)},elements:function(a){return $("."+this.identity(),a)},
publish:function(a,b){this.Class.publish(a,b||this)},hookup:function(a){var b=j(this.Class.shortName),c=$.data(a,"models")||$.data(a,"models",{});$(a).addClass(b+" "+this.identity());c[b]=this}});$.each(["created","updated","destroyed"],function(a,b){$.Model.prototype[b]=function(c){b==="destroyed"&&this.Class.list&&this.Class.list.remove(this[this.Class.id]);$(this).triggerHandler(b);c&&typeof c=="object"&&this.attrs(c.attrs?c.attrs():c);this.publish(b,this);return[this].concat($.makeArray(arguments))}});
$.fn.models=function(){var a=[],b,c;this.each(function(){$.each($.data(this,"models")||{},function(e,f){b=b===undefined?f.Class.List||null:f.Class.List===b?b:null;a.push(f)})});c=new (b||$.Model.List||Array);c.push.apply(c,$.unique(a));return c};$.fn.model=function(a){if(a&&a instanceof $.Model){a.hookup(this[0]);return this}else return this.models.apply(this,arguments)[0]}})(jQuery);
